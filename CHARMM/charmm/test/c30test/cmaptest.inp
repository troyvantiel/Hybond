* Test of dihedral cross-term (CMAP) parameters
* Michael Feig, C.L.Brooks group, TSRI
*

STREAM datadir.def

if ?cmapset .ne. 1 then
 echo "Test NOT performed."
 stop
endif

! read standard topology and parameter files

OPEN UNIT 10 READ FORM NAME @0/top_all22_prot.inp
READ RTF CARD UNIT 10
CLOSE UNIT 10

OPEN UNIT 10 READ FORM NAME @0/par_all22_prot.inp
READ PARA CARD UNIT 10
CLOSE UNIT 10

! patch to rtf for cross-terms

READ RTF CARD APPEND
* CMAP patches
   20    1
PRES CMPT       0.00
CMAP -C  N  CA  C   N  CA  C  +N

END

! and here are CMAP parameters:

READ PARA CARD APPEND
* CMAP parameters
*

CMAP

C    CT1  NH1  C    NH1  C    CT1  NH1   24

-0.37321 0.26870 0.47126 0.75097 1.62101      !-180
2.19543 2.06444 1.76479 0.75587 -0.71347
0.97613 -2.47552 -5.45565 -5.89645 -5.30585
-3.97563 -3.08858 -3.28420 -3.17712 -3.14606
-2.83535 -2.51044 -2.10804 -0.98225 

-0.10229 0.37709 0.57702 0.87229 1.39899      !-165
1.96163 2.33384 1.90407 0.56146 0.51840
-0.11632 -3.57544 -5.28448 -5.16031 -4.19601
-3.27621 -2.71534 -2.30620 -2.10178 -2.21032
-2.00881 -1.63710 -1.00336 -0.47687

0.16519 0.15621 0.62435 1.04720 1.65391       !-150
2.19141 2.29642 1.96045 0.82493 2.03829
-1.15151 -3.74861 -4.65828 -4.53185 -3.79637
-2.57209 -1.72725 -1.46141 -1.28291 -1.47912
-1.23934 -0.91806 -0.37546 0.02364

0.26400 0.52137 0.97744 1.37795 1.92947       !-135
2.39341 2.43581 2.16297 1.76150 1.19009
-1.51861 -3.30890 -3.77610 -3.40534 -2.76844
-1.83603 -0.95795 -0.47821 -0.63276 -0.56588
-0.62117 -0.36232 0.10683 0.35296

0.57395 0.95916 1.50899 1.84110 2.69896       !-120
2.80933 2.61430 2.48172 2.69466 0.68244
-1.39832 -2.56180 -2.74511 -2.49469 -1.80830
-0.85548 -0.08732 -0.06096 -0.30812 -0.18633
0.02279 0.02336 0.23242 0.40402 

0.76738 1.28665 1.81803 2.06550 2.37062       !-105
2.89744 2.73031 2.87879 2.54201 0.54524
-1.09215 -1.69444 -2.01231 -1.60243 -0.65636
-0.30624 -0.12244 -0.05532 -0.18985 0.04137
0.32971 0.27117 0.30236 0.39381

0.65601 1.44318 1.58945 2.04623 2.45151       !-90
2.81916 3.05290 3.87372 2.42065 0.44910
-0.79163 -1.38298 -1.33893 -0.98738 -0.76830
-0.49437 -0.23242 -0.19175 -0.46248 -0.09374
0.06954 0.19746 0.16306 0.30322

-0.00321 0.44909 1.18092 1.94296 2.81407      !-75
3.17580 3.55531 3.88729 2.10126 0.10906
-1.03224 -1.38204 -0.67388 -0.81739 -0.82698
-0.11180 0.05371 -0.20360 -0.30776 -0.57104
-0.63610 -0.23382 -0.09430 -0.39979

-1.45335 -0.27002 0.71696 2.16857 3.20819     !-60
3.86686 4.25108 3.34811 1.29754 -0.48754
-1.17990 -0.68430 -0.85366 -1.15876 -0.34755
0.11481 0.24280 -0.17758 -0.62986 -1.37495
-1.67694 -1.67343 -1.66665 -1.71877

-2.69673 -0.92194 1.34741 3.21135 4.37600     !-45
4.86494 4.35520 2.43651 0.40847 -0.29084
-0.43596 -0.50121 -0.82223 -0.60721 0.05791
0.24658 -0.07057 -0.12057 -0.75223 -1.57168
-2.78291 -3.21577 -3.33982 -2.98711

-2.17472 0.06703 3.18046 5.74161 5.07077      !-30
4.28147 2.75834 1.29581 0.57115 -0.19648
0.25186 -0.73214 1.28936 1.49759 1.89055
2.19849 0.16929 0.03400 -0.66822 -2.27632
-3.55007 -4.31215 -4.13667 -3.64226

-0.70641 4.58807 2.73262 2.21762 2.27245      !-15
1.99232 1.56370 1.35676 0.83141 0.63017
1.59197 0.82192 0.48607 0.71576 0.99602
1.59158 -0.36740 -0.31823 -1.61392 -3.26790
-4.51646 -4.59770 -4.04334 -2.76502

2.33231 0.28799 -0.17672 -0.02077 0.12860     !0
0.47633 1.23875 1.67195 1.64548 2.52034
1.60697 0.77635 0.11978 0.07039 0.12117
-1.56923 -1.21301 -2.34636 -3.24451 -4.29253
-4.43488 -4.11593 -3.17575 -1.42417

-0.77834 -1.91268 -2.05214 -1.84628 -1.04743  !15
0.18340 1.68295 2.22350 1.35837 2.44866
1.43692 0.67857 -0.23706 -0.53532 -0.79038
-2.18258 -3.25114 -4.19511 -4.26927 -3.90821
-3.45562 -2.77397 1.75537 0.31341

-2.96381 -3.48373 -3.51708 -2.72486 -1.40551  !30
0.33620 1.42845 1.39463 0.97037 2.46272
1.52243 0.55362 -0.40738 -1.48295 -3.61392
-4.15981 -4.94558 -4.78404 -3.76454 -2.95914
-1.96385 -1.07126 -1.59958 -2.44532

-4.02907 -3.93266 -3.55848 -2.51398 -1.03732  !45
0.36200 0.81438 0.75411 0.50237 1.90342
0.77022 -0.41642 -3.28631 -3.87527 -4.90780
-5.70443 -5.64566 -4.39604 -2.86545 -2.36817
-2.86049 -3.41656 -3.66649 -3.85907

-3.33827 -2.96022 -2.31170 -1.27289 -0.24647  !60
0.72261 0.66807 0.43813 2.39533 1.63247
-2.04145 -3.21810 -3.91508 -4.85251 -5.69650
-6.31437 -5.68369 -4.17062 -3.14100 -3.50882
-3.75643 -3.64081 -3.64043 -3.55069

-2.24486 -1.63210 -1.00064 -0.17044 0.52644   !75
0.82371 0.51714 -0.01312 -0.37091 -1.21372
-2.30565 -3.42058 -4.48496 -5.69314 -6.19915
-6.25387 -5.21131 -4.17438 -3.68515 -4.15136
-4.16197 -3.72515 -3.71531 -2.60676

-1.72084 -1.17783 -0.42843 0.27773 0.80790    !90
0.80326 0.48251 -0.33690 -0.78627 -1.77407
-2.79322 -3.82856 -5.21180 -6.63685 -6.98994
-6.10880 -5.45241 -3.91145 -4.32100 -4.58724
-4.10261 -3.77282 -3.15730 -2.64839

-1.85064 -1.09242 -0.44502 0.12849 1.00552    !105
0.88482 0.48585 -0.21847 -0.85767 -1.68233
-3.01440 -4.48111 -6.05351 -6.86540 -6.87113
-5.72824 -3.91223 -4.80211 -5.03464 -4.71599
-4.60108 -4.08622 -3.27463 -2.41094

-1.96923 -1.11665 -0.54025 -0.15033 0.76352   !120
1.03889 0.75848 0.31353 -0.33305 -1.87277
-3.36627 -5.00826 -6.12481 -7.03483 -6.72432
-3.70020 -4.51062 -5.18565 -5.36162 -4.84749
-4.44432 -4.00426 -3.41572 -2.75123

-2.11125 -1.16896 -0.32279 -0.00692 0.31666   !135
1.08627 0.93917 0.62534 -0.16636 -1.83031
-3.46947 -4.94603 -6.11256 -1.91558 -4.04731
-4.99674 -4.99673 -4.84269 -4.88662 -4.30054
-4.49462 -4.44221 -4.16357 -3.18351

-1.75759 -0.40362 0.02392 0.36239 0.63452     !150
1.26492 1.36136 0.94842 -0.07368 -1.48356
-3.15282 1.83512 -1.76286 -5.09366 -5.74483
-5.39007 -4.78393 -4.19063 -4.11542 -4.04228
-4.12557 -4.02855 -4.02610 -2.93791

-0.81059 -0.07150 0.37889 0.54331 1.27788     !165
1.64131 1.69884 1.51995 0.63195 -1.08867
-2.73653 -0.73524 -4.56383 -6.40835 -5.88945
-5.14175 -4.19497 -3.66649 -3.84345 -3.81883
-3.82618 -3.59682 -2.99479 -2.23102

END

! setup PSF for simple structure

READ SEQU CARD 
* SIMPLE SEQUENCE FOR TEST
*
 4
ALA ALA LEU LEU

GENERATE PROT FIRST NTER LAST CTER SETUP WARN

! no cross-terms so far

! apply patch (no cross-terms at terminal groups)

PATCH CMPT prot 2
PATCH CMPT prot 3

! now there should be cross-terms

print psf

! build extended chain

IC PARAM
IC SEED prot 1 N prot 1 CA prot 1 C
IC BUILD

! evaluate energy with cross-term

energy

! do some minimization

mini sd nstep 30

! turn off cross-term

skip cmap
energy

! use only CMAP for derivative test
define backbone select type c .or. type ca .or. type n end
skip all excl CMAP 
energy

! test first derivatives

test first step 1E-5 tol 1E-8


! test second derivatives
faster off
test second step 1E-5 tol 0 select backbone end

stop
